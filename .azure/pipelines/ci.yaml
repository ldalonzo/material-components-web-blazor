name: $(Major).$(Minor).$(rev:r)

resources:
- repo: self
  clean: true

pool:
  name: Hosted Windows 2019 with VS2019
  demands:
  - npm

variables:
  Major: 0
  Minor: 1
  BuildConfiguration: 'Release'

steps:
- checkout: self
  clean: true

- script: dotnet restore
  displayName: Restore packages

- script: dotnet build -c $(BuildConfiguration) --no-restore
  displayName: Build

- task: DotNetCoreCLI@2
  displayName: 'Test'
  inputs:
    command: test
    publishTestResults: false
    arguments: '--configuration $(BuildConfiguration) --no-build --results-directory $(Agent.TempDirectory)\TestResults --settings test\coverletArgs.runsettings'

- task: PowerShell@2
  displayName: 'Publish Test Results'
  inputs:
    targetType: 'filepath'
    filePath: 'test/Send-CoverageResultsToCodecov.ps1'
    arguments: '-TestResultsBasePath $(Agent.TempDirectory) -NuGetPackagesBasePath $(UserProfile)\.nuget\packages -CodecovUploadToken $(CodecovUploadToken)'

- task: Npm@1
  displayName: 'Build Static Assets - npm ci'
  inputs:
    command: ci
    workingDir: src\Blazor.Material
    verbose: false

- task: Npm@1
  displayName: 'Build Static Assets - npm run build'
  inputs:
    command: custom
    workingDir: src\Blazor.Material
    verbose: false
    customCommand: 'run build'

- task: DotNetCoreCLI@2
  displayName: 'dotnet publish'
  inputs:
    command: publish
    publishWebProjects: false
    projects: |
     **/Blazor.Material.Components.WebApp.csproj
    arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory) -p:Version=$(Build.BuildNumber)'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'
